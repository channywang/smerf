<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>validate_sub_objects (SmerfItem)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File app/models/smerf_item.rb, line 158</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">validate_sub_objects</span>(<span class="ruby-identifier">object_class</span>, <span class="ruby-identifier">hash</span>, <span class="ruby-identifier">sort_order_field</span>, <span class="ruby-identifier">object_array</span>)    
      <span class="ruby-identifier">errors</span> = <span class="ruby-value str">&quot;&quot;</span>
      <span class="ruby-identifier">array_of_objects</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-comment cmt"># Process each item passed to us in the hash</span>
      <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">item</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">hash</span> <span class="ruby-keyword kw">do</span>
        <span class="ruby-comment cmt"># Create a new onject using the class name passed to us, pass</span>
        <span class="ruby-comment cmt"># in the item contents and the sort order field to the new object</span>
        <span class="ruby-identifier">class_object</span> = <span class="ruby-identifier">object_class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">sort_order_field</span>, <span class="ruby-ivar">@object_ident</span>)     
        <span class="ruby-comment cmt"># Perform the validation on the new object, checking manadatory fields </span>
        <span class="ruby-comment cmt"># are present and performing any custom validations as defined by the </span>
        <span class="ruby-comment cmt"># fields array setup for each class</span>
        <span class="ruby-identifier">errors</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">class_object</span>.<span class="ruby-identifier">validate</span>()
        <span class="ruby-comment cmt"># Add the new object to the object array that will be used by the calling</span>
        <span class="ruby-comment cmt"># object, e.g. smerffile object collects and uses groups          </span>
        <span class="ruby-identifier">array_of_objects</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">class_object</span>
        <span class="ruby-comment cmt"># If the object has a 'code' field move it to the code array to make</span>
        <span class="ruby-comment cmt"># sure all codes are unique either for a complete form or within the</span>
        <span class="ruby-comment cmt"># current object, e.g. answers for a question</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">class_object</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'code'</span>) 
          <span class="ruby-ivar">@class_code_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">class_object</span>.<span class="ruby-identifier">code</span>
          <span class="ruby-ivar">@code_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">class_object</span>.<span class="ruby-identifier">code</span> 
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>     
      <span class="ruby-comment cmt"># Check all items have a unique code</span>
      <span class="ruby-identifier">errors</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">check_duplicate_codes</span>(<span class="ruby-identifier">object_class</span>)
      <span class="ruby-comment cmt"># Sort the items using the supplied sort order field</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">sort_order_field</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">array_of_objects</span> = <span class="ruby-identifier">array_of_objects</span>.<span class="ruby-identifier">sort</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">eval</span>(<span class="ruby-node">&quot;a.#{sort_order_field}&lt;=&gt;b.#{sort_order_field}&quot;</span>)}
        <span class="ruby-comment cmt"># The above function is faster than the one below</span>
        <span class="ruby-comment cmt">#object_array = object_array.sort_by {|item| eval(&quot;item.#{sort_order_field}&quot;)}</span>
      <span class="ruby-keyword kw">end</span>
      <span class="ruby-comment cmt"># Copy all items to the destination array. </span>
      <span class="ruby-comment cmt">#array_of_objects.each {|item| object_array[item.code.to_s] = item}</span>
      <span class="ruby-identifier">object_array</span>.<span class="ruby-identifier">replace</span>(<span class="ruby-identifier">array_of_objects</span>)
      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">errors</span>
    <span class="ruby-keyword kw">end</span></pre>
</body>
</html>